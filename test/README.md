# Photo Magic 文件服务测试脚本

本目录包含了用于验证任务4「实现文件服务」的测试脚本，确保所有开发要求都得到正确实现。

## 测试脚本说明

### 1. comprehensive-file-service-test.js
**全面综合测试脚本**

- **用途**: 自动化测试所有任务4的开发要求
- **特点**: 无需用户交互，全自动执行
- **测试项目**:
  - JWT权限验证
  - 无权限访问拦截
  - 文件上传功能
  - S3存储集成
  - DynamoDB数据存储
  - 文件查询功能
  - 文件访问权限控制
  - 文件类型和大小限制
  - S3生命周期策略验证

**运行方式**:
```bash
# 全面测试
node comprehensive-file-service-test.js

# 交互式测试
node comprehensive-file-service-test.js --interactive
```

### 2. quick-file-test.js
**快速核心功能测试脚本**

- **用途**: 快速验证核心功能是否正常
- **特点**: 轻量级，执行速度快
- **测试项目**:
  - 权限验证
  - 用户登录
  - 文件上传
  - 文件查询
  - 预签名URL生成

**运行方式**:
```bash
node quick-file-test.js
```

### 3. interactive-file-test.js
**交互式测试脚本（增强版）**

- **用途**: 手动交互测试，支持自定义文件路径
- **特点**: 用户友好，详细的错误信息和验证结果
- **测试项目**:
  - 权限验证测试
  - 文件上传和查询
  - S3和DynamoDB集成验证
  - 支持多文件测试

**运行方式**:
```bash
node interactive-file-test.js
```

## 测试前准备

### 1. 环境要求
- Node.js 环境
- 后端服务运行在 `http://localhost:3000`
- AWS 配置正确（S3和DynamoDB）
- 数据库连接正常

### 2. 依赖安装
```bash
npm install axios form-data
```

### 3. 测试数据准备
- 确保 `../test script/test_image.jpeg` 文件存在
- 或准备其他测试图片文件（支持 jpg, jpeg, png, webp 格式）
- 文件大小应小于 10MB

### 4. 测试用户
默认使用以下测试账户：
- 邮箱: `lihongyu822@outlook.com`
- 密码: `TestPassword123!`

## 测试验证项目

### 任务4开发要求验证清单

- ✅ **JWT权限验证**: 验证Token的生成、验证和权限控制
- ✅ **文件上传功能**: 测试文件上传到S3的完整流程
- ✅ **文件查询功能**: 验证从DynamoDB查询文件信息
- ✅ **S3存储架构**: 确认文件正确存储到S3并生成访问URL
- ✅ **DynamoDB集成**: 验证文件元数据正确存储到数据库
- ✅ **安全优化**: 测试权限控制和输入验证
- ✅ **预签名URL生成**: 验证临时访问URL的生成
- ✅ **S3生命周期策略**: 确认生命周期规则配置正确

### S3生命周期策略配置
- `original/` 前缀: 12小时后自动删除
- `processed/` 前缀: 12小时后自动删除
- `temporary/` 前缀: 2小时后自动删除

## 使用建议

### 开发阶段
1. 使用 `quick-file-test.js` 进行快速功能验证
2. 使用 `interactive-file-test.js` 进行详细的手动测试

### 部署前验证
1. 运行 `comprehensive-file-service-test.js` 进行全面测试
2. 确保所有测试项目都通过

### 故障排查
1. 检查后端服务状态
2. 验证AWS配置
3. 确认数据库连接
4. 检查测试文件路径

## 常见问题

### Q: 测试失败，提示401错误
A: 检查用户账户是否存在，密码是否正确

### Q: 文件上传失败
A: 检查AWS S3配置，确认bucket存在且权限正确

### Q: 文件查询失败
A: 检查DynamoDB配置，确认表存在且权限正确

### Q: 预签名URL生成失败
A: 检查AWS凭证配置，确认S3权限包含GetObject操作

## 测试结果解读

- ✅ **绿色勾号**: 测试通过
- ❌ **红色叉号**: 测试失败，需要修复
- ⚠️ **黄色警告**: 测试异常，建议检查

## 扩展测试

如需添加更多测试用例，可以参考现有脚本的结构：

1. 创建测试函数
2. 添加错误处理
3. 提供详细的日志输出
4. 验证预期结果

---

**注意**: 这些测试脚本专门用于验证任务4的开发要求，确保文件服务的所有功能都正确实现。